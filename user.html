<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Update user file</title>
        <link rel="stylesheet" href="styles/styles.css">
        <script src="./scripts/firebase.js"></script>
        <script type="module">
            import { getDatabase, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
            
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            let myUser;

            // Get a reference to the Firebase Realtime Database
            const dbRef = ref(database);

            // Get user to display
            function displayUserData() {
              document.getElementById("firstName").value = myUser.first_name;
              document.getElementById("lastName").value = myUser.last_name;
              document.getElementById("ucfid").value = myUser.ucf_id;
              document.getElementById("nid").value = myUser.nid;
              document.getElementById("cash").value = myUser.knights_cash_account;
              document.getElementById("library").value = myUser.library_account;
              document.getElementById("dob").value = myUser.date_of_birth;
              document.getElementById("expiration").value = myUser.expiration_date;
              document.getElementById("campus").value = myUser.campus;
              document.getElementById("caste").value = myUser.caste;
              document.getElementById("pronouns").value = myUser.pronouns;
            }

          async function updateUser() {
            // Collect the values from the input fields
            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;
            const campus = document.getElementById("campus").value;
            const caste = document.getElementById("caste").value;
            const dateOfBirth = document.getElementById("dob").value;
            const expirationDate = document.getElementById("expiration").value;
            const knightsCashAccount = document.getElementById("cash").value;
            const libraryAccount = document.getElementById("library").value;
            const pronouns = document.getElementById("pronouns").value;
            // Create an object containing the updated user data
            const updatedUserData = {};

          if (firstName) updatedUserData.first_name = firstName;
          if (lastName) updatedUserData.last_name = lastName;
          if (campus) updatedUserData.campus = campus;
          if (caste) updatedUserData.caste = caste;
          if (dateOfBirth) updatedUserData.date_of_birth = dateOfBirth;
          if (expirationDate) updatedUserData.expiration_date = expirationDate;
          if (knightsCashAccount) updatedUserData.knights_cash_account = knightsCashAccount;
          if (libraryAccount) updatedUserData.library_account = libraryAccount;
          if (pronouns) updatedUserData.pronouns = pronouns;

          // Update the user's data in the Firebase Realtime Database
          const userRef = child(ref(database), `users/${myUser.ucf_id}`);
          await update(userRef, updatedUserData);

          // Display a confirmation message and reload the page to show the updated data
          alert("User data updated successfully!");
          window.location.reload();
        }

            
        async function confirmDeleteUser() {
                if (confirm("Are you sure you want to delete this account? This action cannot be undone.")) {
                    const userRef = child(ref(database), `users/${myUser.ucf_id}`);
                    await remove(userRef);
                    alert("User data deleted successfully!");
                    window.location.href = "KnightsCrest_AdminHome.html";
                }
            }

            window.confirmDeleteUser = confirmDeleteUser;

            function init() {
             // Get the UCF ID from the URL query parameter
             const urlParams = new URLSearchParams(window.location.search);
             const ucfid = urlParams.get('ucfid');

             const userRef = child(ref(database), `users/${ucfid}`);


            // Retrieve the user's data from the database
            get(userRef).then((snapshot) => {
            if (snapshot.exists()) {
              const user = snapshot.val();
              myUser = user; 
              console.log(user);
            }         
          })
            // Attach event listeners
            document.getElementById("delete").addEventListener("click", function(event) {
              event.preventDefault();
              confirmDeleteUser();
            });
            
      }
        window.addEventListener("load", init, false);

</script>
        </script>
    </head>
    <body>
        <!--Add UCF Banner-->
        <div class="banner">
            <div class="ucf_banner">
                <div class="ucf_logos">
                  <img src="admin/User Search/The tab crop.png" alt="logo" width="50">
                <img src="admin/User Search/KNIGHTS CREST.png" alt="logo" height = "32px">
                </div>
        
                <div class = "top_menu">
                  <a href = "KnightsCrest_AdminUserSettings.html">
                  <img src = "Admin/Dashboard/Icon material-settings.png" alt="settings" width="25"> 
                  </a>/n
                  
                  <a href = "KnightsCrest_Admin.html">
                  <img src = "Admin/Dashboard/Icon ionic-md-exit.png" alt="settings" width="24">
                  </a>
                </div>
            </div>
        </div>
        <!--Add Sidebar-->
        <div class="sidenav">
            <img id = "profile_pic" src="admin/Add New User/Component 31. 3.png" alt="Profile Pic">
          
              <h2 id = "sidebar_title">Functions</h2>
              <a href = "KnightsCrest_AdminHome.html">
              <button id = "button">
                <img src="admin/User Search/Search Records Button.png" alt="Search Records">
             </button>
              </a>
          
             <a href = "KnightsCrest_AdminAdd.html">
             <button id = "button">
              <img src="admin/User Search/Add Record Button.png" alt="Add Records">
           </button>
             </a>
           </div>
           <div id = title>
            <h1>RESULTS</h1>  
          </div>
        <div class = "main">
      <!-- Search form -->
      <div class="row">
        <form name="update">
          <fieldset>
        <div class="column">
            <label for="firstName">First name:</label><br>
        <input type="text" id='#firstName' name="firstName" placeholder="First Name"><br><br>
        
        <label for="cash">Knights Cash Account:</label><br>
        <input type="text" id="cash" name="cash" placeholder=""><br><br>
    
        <label for="dob">Date of Birth:</label><br>
        <input type="text" id="dob" name="dob" placeholder="DD/MM/YYYY"><br><br>

        <label for="campus">Campus:</label><br>
        <select id="campus">
          <option value="" disabled selected>Select a campus</option>
          <option value="Main Campus">UCF Main Campus</option>
          <option value="Downtown">UCF Downtown</option>
          <option value="Online">UCF Online</option>
          <option value="Rosen">Rosen</option>
        </select><br><br>

        <input type="submit"  id="update" name="submit" value="Update">
        <input type="button"  id="delete" onclick="confirmDeleteUser()" name="submit" value="Delete">

        </div>
    
            <label for="library">Library Number:</label><br>
            <input type="text" id="library" name="library" placeholder="2210347983785"><br><br>

            <label for="expiration">Expiration Date:</label><br>
            <input type="text" id="expiration" name="expiration" placeholder="05/23/2025"><br><br>

            <label for="caste">Caste:</label><br>
            <select id ="caste">
              <option value="" disabled selected>Select caste</option>
              <option value="Student">Student</option>
              <option value="Teacher">Teacher</option>
              <option value="Staff">Staff</option>
            </select><br><br>

            <label for="pronouns">Preferred pronoun:</label><br>
            <select id="pronouns">
              <option value="" disabled selected>Select pronoun</option>
              <option value="He/Him/His">He/Him/His</option>
              <option value="She/Her/Hers">She/Her/Hers</option>
              <option value="They/Them/Theirs">They/Them/Theirs</option>
              <option value="Ze/Hir/Hirs">Ze/Hir/Hirs</option>
              <option value="Xe/Xem/Xyr">Xe/Xem/Xyr</option>
              <option value="Other">Other</option>
            </select><br><br>
        </fieldset>
        </form> 
    </body>
</html>
