<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Update user file</title>
        <link rel="stylesheet" href="styles/styles.css">
        <script src="./scripts/firebase.js"></script>
        <script type="module">
            import { getDatabase, ref, child, get, update, remove } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
            
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            let myUser;
            

            // Get a reference to the Firebase Realtime Database
            const dbRef = ref(database);

            function getUCFIDFromURL() {
              const urlParams = new URLSearchParams(window.location.search);
              return urlParams.get('ucfid');
            }
            async function fetchUserData(ucf_id) {
              const userRef = ref(database, 'users/' + ucf_id);
              const snapshot = await get(userRef);
              if (snapshot.exists()) {
                myUser = snapshot.val();
              } else {
              console.error('No user found with the specified UCF ID');
              }
              }
              function displayUserData() {
                if (myUser) {
                  document.getElementById('firstName').value = myUser.first_name;
                  document.getElementById('cash').value = myUser.knights_cash_account;
                  document.getElementById('dob').value = myUser.date_of_birth;
                  document.getElementById('campus').value = myUser.campus;
                  document.getElementById('library').value = myUser.library_account;
                  document.getElementById('expiration').value = myUser.expiration_date;
                  document.getElementById('caste').value = myUser.caste;
                  document.getElementById('pronouns').value = myUser.pronouns;
                }
              }
              // Update
              async function updateUser(event) {
  event.preventDefault();

  // Update myUser properties if the corresponding input fields are not empty
  const firstNameInput = document.getElementById("firstName");
  if (firstNameInput.value) myUser.first_name = firstNameInput.value;

  const cashInput = document.getElementById("cash");
  if (cashInput.value) myUser.knights_cash_account = cashInput.value;

  const dobInput = document.getElementById("dob");
  if (dobInput.value) myUser.date_of_birth = dobInput.value;

  const campusSelect = document.getElementById("campus");
  if (campusSelect.value) myUser.campus = campusSelect.value;

  const libraryInput = document.getElementById("library");
  if (libraryInput.value) myUser.library_account = libraryInput.value;

  const expirationInput = document.getElementById("expiration");
  if (expirationInput.value) myUser.expiration_date = expirationInput.value;

  const casteSelect = document.getElementById("caste");
  if (casteSelect.value) myUser.caste = casteSelect.value;

  const pronounsSelect = document.getElementById("pronouns");
  if (pronounsSelect.value) myUser.pronouns = pronounsSelect.value;

  // Update the user data in the Firebase Realtime Database
  const userRef = child(dbRef, `users/${myUser.nid}`);
  await update(userRef, myUser);

  // Display a success message and reload the user data
  alert("User information updated successfully!");
  displayUserData(myUser);
}

              
              async function init() {
                const ucf_id = getUCFIDFromURL();

                if (ucf_id) {
                await fetchUserData(ucf_id);
                displayUserData();
                } else {
                console.error('No UCF ID provided in the URL');
                }                
                const updateButton = document.getElementById("update");
                updateButton.addEventListener("click", updateUser);
              }

            window.addEventListener("load", init, false);
        </script>
    </head>
    <body>
        <!--Add UCF Banner-->
        <div class="banner">
            <div class="ucf_banner">
                <div class="ucf_logos">
                  <img src="admin/User Search/The tab crop.png" alt="logo" width="50">
                <img src="admin/User Search/KNIGHTS CREST.png" alt="logo" height = "32px">
                </div>
        
                <div class = "top_menu">
                  <a href = "KnightsCrest_AdminUserSettings.html">
                  <img src = "Admin/Dashboard/Icon material-settings.png" alt="settings" width="25"> 
                  </a>/n
                  
                  <a href = "KnightsCrest_Admin.html">
                  <img src = "Admin/Dashboard/Icon ionic-md-exit.png" alt="settings" width="24">
                  </a>
                </div>
            </div>
        </div>
        <!--Add Sidebar-->
        <div class="sidenav">
            <img id = "profile_pic" src="admin/Add New User/Component 31. 3.png" alt="Profile Pic">
          
              <h2 id = "sidebar_title">Functions</h2>
              <a href = "KnightsCrest_AdminHome.html">
              <button id = "button">
                <img src="admin/User Search/Search Records Button.png" alt="Search Records">
             </button>
              </a>
          
             <a href = "KnightsCrest_AdminAdd.html">
             <button id = "button">
              <img src="admin/User Search/Add Record Button.png" alt="Add Records">
           </button>
             </a>
           </div>
           <div id = title>
            <h1>RESULTS</h1>  
          </div>
        <div class = "main">
      <!-- Search form -->
      <div class="row">
        <form name="update">
          <fieldset>
        <div class="column">
            <label for="firstName">First name:</label><br>
        <input type="text" id='firstName' name="firstName" placeholder="First Name"><br><br>
        
        <label for="cash">Knights Cash Account:</label><br>
        <input type="text" id="cash" name="cash" placeholder=""><br><br>
    
        <label for="dob">Date of Birth:</label><br>
        <input type="text" id="dob" name="dob" placeholder="DD/MM/YYYY"><br><br>

        <label for="campus">Campus:</label><br>
        <select id="campus">
          <option value="" disabled selected>Select a campus</option>
          <option value="Main Campus">UCF Main Campus</option>
          <option value="Downtown">UCF Downtown</option>
          <option value="Online">UCF Online</option>
          <option value="Rosen">Rosen</option>
        </select><br><br>

        <input type="submit"  id="update" name="submit" value="Update">
        <input type="button"  id="delete" name="submit" value="Delete">

        </div>
    
            <label for="library">Library Number:</label><br>
            <input type="text" id="library" name="library" placeholder="2210347983785"><br><br>

            <label for="expiration">Expiration Date:</label><br>
            <input type="text" id="expiration" name="expiration" placeholder="05/23/2025"><br><br>

            <label for="caste">Caste:</label><br>
            <select id ="caste">
              <option value="" disabled selected>Select caste</option>
              <option value="Student">Student</option>
              <option value="Teacher">Teacher</option>
              <option value="Staff">Staff</option>
            </select><br><br>

            <label for="pronouns">Preferred pronoun:</label><br>
            <select id="pronouns">
              <option value="" disabled selected>Select pronoun</option>
              <option value="He/Him/His">He/Him/His</option>
              <option value="She/Her/Hers">She/Her/Hers</option>
              <option value="They/Them/Theirs">They/Them/Theirs</option>
              <option value="Ze/Hir/Hirs">Ze/Hir/Hirs</option>
              <option value="Xe/Xem/Xyr">Xe/Xem/Xyr</option>
              <option value="Other">Other</option>
            </select><br><br>
        </fieldset>
        </form> 
    </body>
</html>
